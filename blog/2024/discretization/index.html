<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> DDIM and Natural Euler Samplers | Rectified Flow </title> <meta name="author" content="Rectified Flow "> <meta name="description" content="Even discretized trajectories are equivalent"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://rectifiedflow.github.io/blog/2024/discretization/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" integrity="sha256-q9ba7o845pMPFU+zcAll8rv+gC+fSovKsOoNQ6cynuQ=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css" integrity="sha256-Oppd74ucMR5a5Dq96FxjEzGF7tTw2fZ/6ksAqDCM8GY=" crossorigin="anonymous" media="screen and (prefers-color-scheme: light)"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" integrity="sha256-nyCNAiECsdDHrr/s2OQsp5l9XeY2ZJ0rMepjCT2AkBk=" crossorigin="anonymous" media="screen and (prefers-color-scheme: dark)"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/css/diff2html.min.css" integrity="sha256-IMBK4VNZp0ivwefSn51bswdsrhk0HoMTLc2GqFHFBXg=" crossorigin="anonymous"> <link defer rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css"> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10.7.0/dist/mermaid.min.js" integrity="sha256-TtLOdUA8mstPoO6sGvHIGx2ceXrrX4KgIItO06XOn8A=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js" integrity="sha256-1rA678n2xEx7x4cTZ5x4wpUCj6kUMZEZ5cxLSVSFWxw=" crossorigin="anonymous"></script> <script>let mermaidTheme=determineComputedTheme();document.addEventListener("readystatechange",()=>{"complete"===document.readyState&&(document.querySelectorAll("pre>code.language-mermaid").forEach(e=>{const t=e.textContent,d=e.parentElement;d.classList.add("unloaded");let a=document.createElement("pre");a.classList.add("mermaid");const n=document.createTextNode(t);a.appendChild(n),d.after(a)}),mermaid.initialize({theme:mermaidTheme}),"undefined"!=typeof d3&&window.addEventListener("load",function(){d3.selectAll(".mermaid svg").each(function(){var e=d3.select(this);e.html("<g>"+e.html()+"</g>");var t=e.select("g"),d=d3.zoom().on("zoom",function(e){t.attr("transform",e.transform)});e.call(d)})}))});</script> <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/js/diff2html-ui.min.js" integrity="sha256-eU2TVHX633T1o/bTQp6iIJByYJEtZThhF9bKz/DcbbY=" crossorigin="anonymous"></script> <script>let diff2HtmlTheme=determineComputedTheme();document.addEventListener("readystatechange",()=>{"complete"===document.readyState&&document.querySelectorAll("pre>code.language-diff2html").forEach(e=>{const t=e.textContent,d=e.parentElement;d.classList.add("unloaded");let l=document.createElement("div");l.classList.add("diff2html"),d.after(l),new Diff2HtmlUI(l,t,{colorScheme:diff2HtmlTheme,drawFileList:!0,highlight:!0,matching:"lines"}).draw()})});</script> <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js" integrity="sha256-MgH13bFTTNqsnuEoqNPBLDaqxjGH+lCpqrukmXc8Ppg=" crossorigin="anonymous"></script> <script>document.addEventListener("readystatechange",()=>{"complete"===document.readyState&&document.querySelectorAll("pre>code.language-geojson").forEach(e=>{const t=e.textContent,a=e.parentElement;a.classList.add("unloaded");let o=document.createElement("div");o.classList.add("map"),a.after(o);var n=L.map(o);L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(n);let d=L.geoJSON(JSON.parse(t)).addTo(n);n.fitBounds(d.getBounds())})});</script> <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha256-0q+JdOlScWOHcunpUk21uab1jW7C1deBQARHtKMcaB4=" crossorigin="anonymous"></script> <script>$(document).ready(function(){var t=null,a=null,e=null,n="";$(".language-chartjs").each(function(){a=$(this),t=$("<canvas></canvas>"),n=a.text(),a.text("").append(t),(e=t.get(0).getContext("2d"))&&n&&new Chart(e,JSON.parse(n))&&a.attr("data-processed",!0)})});</script> <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js" integrity="sha256-QvgynZibb2U53SsVu98NggJXYqwRL7tg3FeyfXvPOUY=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/theme/dark-fresh-cut.js" integrity="sha256-sm6Ui9w41++ZCWmIWDLC18a6ki72FQpWDiYTDxEPXwU=" crossorigin="anonymous"></script> <script>let echartsTheme=determineComputedTheme();document.addEventListener("readystatechange",()=>{"complete"===document.readyState&&document.querySelectorAll("pre>code.language-echarts").forEach(e=>{const t=e.textContent,a=e.parentElement;a.classList.add("unloaded");let r=document.createElement("div");if(r.classList.add("echarts"),a.after(r),"dark"===echartsTheme)var n=echarts.init(r,"dark-fresh-cut");else n=echarts.init(r);n.setOption(JSON.parse(t)),window.addEventListener("resize",function(){n.resize()})})});</script> <script defer src="https://cdn.jsdelivr.net/npm/vega@5.27.0/build/vega.min.js" integrity="sha256-Yot/cfgMMMpFwkp/5azR20Tfkt24PFqQ6IQS+80HIZs=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/vega-lite@5.16.3/build/vega-lite.min.js" integrity="sha256-TvBvIS5jUN4BSy009usRjNzjI1qRrHPYv7xVLJyjUyw=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/vega-embed@6.24.0/build/vega-embed.min.js" integrity="sha256-FPCJ9JYCC9AZSpvC/t/wHBX7ybueZhIqOMjpWqfl3DU=" crossorigin="anonymous"></script> <script>let vegaTheme=determineComputedTheme();document.addEventListener("readystatechange",()=>{"complete"===document.readyState&&document.querySelectorAll("pre>code.language-vega_lite").forEach(e=>{const t=e.textContent,a=e.parentElement;a.classList.add("unloaded");let d=document.createElement("div");d.classList.add("vega-lite"),a.after(d),"dark"===vegaTheme?vegaEmbed(d,JSON.parse(t),{theme:"dark"}):vegaEmbed(d,JSON.parse(t))})});</script> <script defer src="https://tikzjax.com/v1/tikzjax.js" integrity="sha256-+1qyucCXRZJrCg3lm3KxRt/7WXaYhBid4/1XJRHGB1E=" crossorigin="anonymous"></script> <script src="/assets/js/typograms.js?63f3caa50c7a9624f953b3aec207afa6"></script> <script>document.addEventListener("readystatechange",()=>{"complete"===document.readyState&&document.querySelectorAll("pre>code.language-typograms").forEach(e=>{const t=e.textContent,n=e.parentElement.parentElement;let a=document.createElement("pre");a.classList.add("typogram");const d=create("\n"+t,.3,!1);a.appendChild(d),n.appendChild(a),n.removeChild(e.parentElement)})});</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "DDIM and Natural Euler Samplers",
            "description": "Even discretized trajectories are equivalent",
            "published": "December 10, 2024",
            "authors": [
              
              {
                "author": "Runlong Liao",
                "authorURL": "mailto:rectifiedflow@googlegroups.com",
                "affiliations": [
                  {
                    "name": "UT Austin",
                    "url": ""
                  }
                ]
              },
              
              {
                "author": "Xixi Hu",
                "authorURL": "",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },
              
              {
                "author": "Bo Liu",
                "authorURL": "",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },
              
              {
                "author": "Qiang Liu",
                "authorURL": "",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              }
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Rectified Flow</span> </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>DDIM and Natural Euler Samplers</h1> <p>Even discretized trajectories are equivalent</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#overview">Overview</a> </div> <div> <a href="#affine-interpolation-solver">Affine Interpolation Solver</a> </div> <div> <a href="#natural-euler-sampler">Natural Euler Sampler</a> </div> <div> <a href="#equivalence-of-natural-euler-trajectories">Equivalence of Natural Euler Trajectories</a> </div> </nav> </d-contents> <h2 id="overview">Overview</h2> <p>Rectified flow learns an ODE of the form \(\mathrm{d}Z_t = v_t(Z_t; \theta)\) by minimizing the loss between its velocity field and the slope of an interpolation process. As <a href="../interpolation/#affine-interpolations-are-pointwise-transformable">previously discussed</a>, affine interpolations yield essentially equivalent rectified flows thus identical couplings.</p> <p>In practice, those ODE trajectories must be approximated by <strong>discrete steps</strong>. A standard approach is the Euler method: at each step, the local trajectory is approximated by its tangent line. For rectified flows induced by straight interpolation, this is a intuitive choice. However, if the interpolation is nonlinear (e.g., spherical), it may be more natural to approximate each step with a locally curved segment that matches the interpolation. We refer to such methods as <strong>natural Euler samplers</strong>.</p> <p>Notably, the DDIM sampler can be viewed as a natural Euler sampler under its interpolation. In this perspective, we can understand DDIM without complex derivation of its coefficients.</p> <p>A key property shares across pointwise transformable interpolations is:</p> <blockquote class="definition"> <p>If two interpolation processes are pointwise transformable into one another using maps \(\phi\) and \(\tau\), then the <strong>discrete sampling points produced by their respective natural Euler samplers are also pointwise transformable</strong> under the same mappings, provided their time grids are related by a time scaling function \(\tau_t\).</p> </blockquote> <p>In other words, <strong>when using natural Euler samplers, changing the affine interpolation scheme <em>at inference time</em> is essentially adjusting the sampling time grid.</strong> In the case of DDIM, one obtains <strong>exactly the same results</strong> as those produced by the vanilla Euler sampler (appropriately rescaling the time grid) applied to a rectified flow induced by a straight interpolation.</p> <p>For a more comprehensive and rigorous discussion on this topic, please refer to Chapter 5 in the <a href="https://github.com/lqiang67/rectified-flow/tree/main/pdf" rel="external nofollow noopener" target="_blank">Rectified Flow Lecture Notes</a>.</p> <h2 id="affine-interpolation-solver">Affine Interpolation Solver</h2> <p>Given a coupling \((X_0, X_1)\) of source distirbution \(X_0 \sim \pi_0\) and target unknown data distribution \(X_1 \sim \pi_1\), we define an interpolation function formally:</p> <blockquote class="definition"> <p><strong>Definition 1.</strong> Let \(\mathtt I:[0,1] \times \mathbb R^d \times \mathbb R^d \mapsto \mathbb R^d\) be a <strong>interpolation function</strong> satisfying</p> \[\mathtt I_0(x_0, x_1) = x_0, \quad \mathtt I_1(x_0, x_1)=x_1.\] <p>We construct the interpolation process \(\{X_t\}\) by</p> \[X_t = \mathtt I_t(X_0, X_1).\] <p>We also require that \(\{X_t\}\) is differentiable in time, that is, the time derivative exists pointwise</p> \[\dot{X}_t := \partial_t \mathtt{I}_t(X_0, X_1).\] </blockquote> <p>In many cases, given \((X_t, \dot{X}_t)\), we wish to recover \((X_0, X_1)\) that satisfy</p> \[\begin{cases} X_t = \mathtt{I}_t(X_0, X_1), \\[6pt] \dot{X}_t = \partial_t \mathtt{I}_t(X_0, X_1). \end{cases}\] <p>For affine interpolations \((X_t = \alpha_t X_1 + \beta_t X_0)\), this problem reduces to solving a simple \(2 \times 2\) linear system. Moreover, because expectations are linear, conditional expectations under affine interpolation also inherit this linear structure.</p> <blockquote class="example"> <p><strong>Affine Interpolation Solvers.</strong> Define</p> \[\begin{aligned} v_t(x) &amp;:= \mathbb{E}[\dot{X}_t \mid X_t = x], &amp;\text{(RF velocity field)} \\[6pt] \hat{x}_{0\mid t}(x) &amp;:= \mathbb{E}[X_0 \mid X_t = x], &amp;\text{(Expected noise $X_0$)} \\[6pt] \hat{x}_{1\mid t}(x) &amp;:= \mathbb{E}[X_1 \mid X_t = x]. &amp;\text{(Expected data $X_1$)} \end{aligned}\] <p>Given any two of \(\{v_t, \hat x_{0\mid t}, \hat x_{1\mid t}, x_t\}\) or \(\{\dot X_t, X_0, X_1, X_t\}\), we can explicitly solve for the other two that satisfy</p> \[X_t = \alpha_t X_1 + \beta_t X_0, \quad \dot{X}_t = \dot{\alpha}_t X_1 + \dot{\beta}_t X_0. \\\] <p>or</p> \[x_t =\alpha_t\hat{x}_{1\mid t} + \beta_t \hat{x}_{0\mid t}, \quad v_t = \dot \alpha_t \hat{x}_{1\mid t} + \dot \beta_t \hat{x}_{0\mid t}\] <p>This can be efficiently implemented as <a href="https://github.com/lqiang67/rectified-flow/blob/main/rectified_flow/flow_components/interpolation_solver.py" rel="external nofollow noopener" target="_blank">affine interpolation solvers</a>.</p> </blockquote> <h2 id="natural-euler-sampler">Natural Euler Sampler</h2> <p>The vanilla Euler method approximates the flow \(\{Z_t\}\) on a discrete time grid \(\{t_i\}\) by locally linear steps:</p> \[\hat{z}_{t_{i+1}} = \hat{z}_{t_i} + (t_{i+1} - t_i) \cdot v_{t_i}(\hat{z}_{t_i}).\] <p>At each step, the solution is approximated by the straight line tangent to the rectified flow at \(\hat{z}_{t_i}\).</p> <p>In contrast, the <strong>natural Euler sampler</strong> replaces the straight line with an interpolation curve that is tangent at \(\hat{z}_{t_i}\). The update rule becomes:</p> \[\hat{z}_{t_{i+1}} = \mathtt{I}_{t_{i+1}}(\hat{x}_{0 \mid t_i}, \hat{x}_{1 \mid t_i}),\] <p>where \(\hat{x}_{0 \mid t_i}\) and \(\hat{x}_{1 \mid t_i}\) are obtained through the affine interpolation solver. These serve as the estimated endpoints of the interpolation curve passing through \(\hat{z}_{t_i}\) and matching the slope \(\partial \mathtt I_{t_i}(\hat{x}_{0 \mid t_i}, \hat{x}_{1 \mid t_i}) = v_{t_i}(\hat{z}_{t_i})\) at time \(t_i\). In other words, the natural Euler method updates the solution by advancing along a locally curved path that is consistent with underlying interpolation curve.</p> <p>For instance, the natural euler sampler under spherical rectified flow can be derived as:</p> <blockquote class="example"> <p><strong>Example 1. Natural Euler Sampler for Spherical Interpolation</strong></p> \[\hat z_{t + \epsilon} =\cos\left(\frac{\pi}{2} \cdot\epsilon\right) \cdot \hat z_{t} + \frac{2}{\pi} \sin \left(\frac{\pi}{2} \cdot\epsilon\right) \cdot v_t(\hat z_t)\] </blockquote> <p>As a more involved example, consider the DDIM algorithm. Despite its complex appearance, DDIM’s inference scheme can be viewed as a natural Euler sampler:</p> <blockquote class="example"> <p><strong>Example 2. Natural Euler Sampler for DDIM</strong></p> <p>The discretized inference scheme of DDIM is the instance of natural Euler sampler for spherical interpolations satisfying \(\alpha_t^2 + \beta_t^2 = 1\). The inference update of DDIM is written in terms of the expected noise \(\hat{x}_{0\mid t}(x) = \mathbb{E}[X_0 \mid X_t = x]\), we rewrite the update steo using \(\hat{x}_{0 \mid t}\):</p> \[\begin{aligned} \hat{z}_{t+\epsilon} &amp;= \alpha_{t+\epsilon} \cdot\hat{x}_{1\vert t}(\hat{z}_t) + \beta_{t+\epsilon} \cdot \hat{x}_{0\vert t}(\hat{z}_t) \\ &amp;\overset{*}{=} \alpha_{t+\epsilon} \left( \frac{\hat{z}_t - \beta_t \cdot\hat{x}_{0\vert t}(\hat{z}_t)}{\alpha_t} \right) + \beta_{t+\epsilon} \cdot \hat{x}_{0\vert t}(\hat{z}_t) \\ &amp;= \frac{\alpha_{t+\epsilon}}{\alpha_t} \hat{z}_t + \left( \beta_{t+\epsilon} - \frac{\alpha_{t+\epsilon} \beta_t}{\alpha_t} \right) \hat{x}_{0\vert t}(\hat{z}_t) \end{aligned}\] <p>where in \(\overset{*}{=}\) we used \(\alpha_t \cdot \hat{x}_{1\vert t}(\hat{z}_t) + \beta_t\cdot \hat{x}_{0\vert t}(\hat{z}_t) = \hat{z}_t\). We can slightly rewrite the update as:</p> \[\frac{\hat{z}_{t+\epsilon}}{\alpha_{t+\epsilon}} = \frac{\hat{z}_t}{\alpha_t} + \left( \frac{\beta_{t+\epsilon}}{\alpha_{t+\epsilon}} - \frac{\beta_t}{\alpha_t} \right) \hat{x}_{0\vert t}(\hat{z}_t),\] <p>which exactly matches Equation 13 of <d-cite key="song2020denoising"></d-cite>.</p> </blockquote> <h2 id="equivalence-of-natural-euler-trajectories">Equivalence of Natural Euler Trajectories</h2> <p>The trajectory points obtained from natural Euler samplers are equivalent under pointwise transformations.</p> <blockquote class="theorem"> <p><strong>Theorem 1. Equivalence of Natural Euler Trajectories</strong></p> <p>Suppose \(\{X_t\}\) and \(\{X_t'\}\) are two interpolation processes contructed from the same couping and that they’re related by a pointwise transform \(X_t' = \phi_t(X_{\tau_t})\). Consider the trajectories \(\{\hat{z}_{t_i}\}_i\) and \(\{\hat{z}_{t_i'}'\}_i\), generated by applying the natural Euler method to the rectified flows induced by \(\{X_t\}\) and \(\{X_t'\}\), respectively, on time grids \(\{t_i\}\) and \(\{t_i'\}\).</p> <p>If the time grids satisfy \(\tau(t_i') = t_i\) for all \(i\), and the initial conditions align via \(\hat{z}_{t_0}' = \phi(\hat{z}_{t_0})\), then the <strong>discrete</strong> trajectories also match under the same transform:</p> \[\hat{z}_{t_i'}' = \phi_{t_i}(\hat{z}_{t_i}) \quad \text{for all } i = 0,1,\ldots\] <p>In particular, applying the natural Euler method to a rectified flow induced by an affine interpolation \(\{X_t'\}\) on a uniform grid \(t_i' = i/n\) is equivalent to applying the standard (straight) Euler method to the rectified flow induced by the corresponding straight interpolation \(\{X_t\}\), but with a non-uniform time grid \(t_i = \tau(i/n)\).</p> </blockquote> <p>This <strong>discrete-level equivalence</strong> extends the continuous-time theorem, ensuring that natural Euler samplers inherit the same invariances as the underlying rectified flow ODE.</p> <p>Let \(\{X_t'\} = \texttt{Transform}(\{X_t\})\) denote a pointwise transformation, and let \(\texttt{NaturalEulerRF}\) represent the operation of generating discrete trajectories from a rectified flow ODE using the natural Euler sampler. Then:</p> \[\texttt{NaturalEulerRF}(\texttt{Transform}(\{X_t\})) = \texttt{Transform}(\texttt{NaturalEulerRF}(\{X_t\})).\] <blockquote class="example"> <p><strong>Example 3. Equivalence of Straight Euler and DDIM sampler</strong></p> <p>Since DDIM is the natural Euler sampler under spherical interpolation, and the vanllia Euler method is the natural Euler under the straight interpolation, they yield the same results under proper transform on the time grid. Specifically, the natural Euler sampler on an affine interpolation \(X_t' = \alpha'_t X_1 + \beta'_t X_0\) using a uniform time grid \(t'_i = i/n\) is equivalent to applying the vanilla (straight) Euler method to the straight RF (induced from \(X_t = tX_1 + (1 - t)X_0\)) but with a non-uniform time grid:</p> \[t_i = \frac{\alpha'_{i/n}}{\alpha'_{i/n}+\beta'_{i/n}}\] <p>Conversely, starting from the straight RF and using a vanilla Euler sampler on the time grid \(\{t_i\}\), one can recover the DDIM sampler by finding a time grid \(\{t'_i\}\) that satisfies:</p> \[t_i = \frac{\alpha'_{t_{i'}}}{\alpha_{t_{i'}}'+\beta'_{t_i'}}\] </blockquote> <p>In the following figures, we compare two equivalent rectified flows (RFs): one induced by a straight interpolation and another by a spherical interpolation (which DDIM essentially represents via a time rescaling). We first train a straight RF and then convert it into a spherical RF, ensuring that they are exactly equivalent.</p> <div class="l-body-outset"> <figure id="figure-1"> <iframe src="/assets/plotly/discrete_euler.html" frameborder="0" scrolling="no" height="630px" width="100%"> </iframe> <figcaption> <a href="#figure-1">Figure 1</a>. Using the standard Euler method for both the straight and spherical RFs with 10 uniform steps in \([0,1]\), we see that, despite their theoretical equivalence, discretization errors accumulate, resulting in significantly different final samples. </figcaption> </figure> </div> <div class="l-body-outset"> <figure id="figure-2"> <iframe src="/assets/plotly/discrete_natural_unmatch.html" frameborder="0" scrolling="no" height="630px" width="100%"> </iframe> <figcaption> <a href="#figure-2">Figure 2</a>. When using the natural Euler sampler with 10 uniform steps in \([0,1]\) for both the straight and spherical RFs, the resulting samples are nearly identical. Minor discrepancies arise because the time parameterizations do not perfectly align. </figcaption> </figure> </div> <div class="l-body-outset"> <figure id="figure-3"> <iframe src="/assets/plotly/discrete_natural_match.html" frameborder="0" scrolling="no" height="630px" width="100%"> </iframe> <figcaption> <a href="#figure-3">Figure 3</a>. After re-scaling the straight RF’s time grid using \(\tau_t\), (and the spherical one still uses uniform time grid) the natural Euler sampling trajectories match exactly between the straight and spherical RFs, confirming that the remaining differences were purely due to mismatched time parameterizations. </figcaption> </figure> </div> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/2024-12-10-discritization.bib"></d-bibliography> </div> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"post-ddim-and-natural-euler-samplers",title:"DDIM and Natural Euler Samplers",description:"Even discretized trajectories are equivalent",section:"Posts",handler:()=>{window.location.href="/blog/2024/discretization/"}},{id:"post-from-flow-to-diffusion-langevin-is-a-guardrail",title:"From Flow to Diffusion: Langevin is a Guardrail",description:"Deriving stochastic samplers from flow and why it helps",section:"Posts",handler:()=>{window.location.href="/blog/2024/samplers/"}},{id:"post-all-flows-are-one-flow",title:"All Flows are One Flow",description:"Affine Interpolations Result in Equivalent Rectified Flows",section:"Posts",handler:()=>{window.location.href="/blog/2024/interpolation/"}},{id:"post-rectified-flow-an-introduction",title:"Rectified Flow: An Introduction",description:"A First Introduction to Rectified Flow",section:"Posts",handler:()=>{window.location.href="/blog/2024/intro/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%72%65%63%74%69%66%69%65%64%66%6C%6F%77@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=XEx1fZkAAAAJ","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>